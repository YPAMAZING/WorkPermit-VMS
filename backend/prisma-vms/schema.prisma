// VMS (Visitor Management System) Database Schema
// Multi-Tenant Architecture with QR-based Self Check-in
// Using MySQL for all environments

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/vms-client"
}

datasource db {
  provider = "mysql"
  url      = env("VMS_DATABASE_URL")
}

// ================================
// COMPANY / TENANT MANAGEMENT
// Multi-tenant support for subscription model
// ================================

model Company {
  id              String    @id @default(uuid())
  code            String    @unique  // Unique company code for QR
  name            String
  displayName     String
  description     String?
  logo            String?
  address         String?
  city            String?
  state           String?
  country         String?
  pincode         String?
  phone           String?
  email           String?
  website         String?
  
  // Subscription & Plan
  subscriptionPlan  String    @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  subscriptionActive Boolean  @default(true)  // On/Off toggle for admin
  maxVisitorsPerMonth Int     @default(100)
  maxUsers          Int       @default(5)
  
  // Portal access for company clients
  portalId          String?   @unique  // Unique portal ID for company clients
  
  // QR Code for self check-in
  qrCode            String?   // Base64 QR code image
  qrCodeData        String?   // QR code data JSON
  qrCodeUrl         String?   // Public URL for QR scanning
  
  // Customization
  primaryColor      String?   // Brand color
  secondaryColor    String?
  welcomeMessage    String?
  termsAndConditions String?
  
  // Settings
  requireIdProof    Boolean   @default(true)
  requirePhoto      Boolean   @default(true)
  autoApprove       Boolean   @default(false) // Auto-approve visitors
  notifyHost        Boolean   @default(true)
  
  // Approval-based gatepass feature
  // If true: visitors must be approved before gatepass is generated
  // If false: visitors can directly get gatepass (DEFAULT - direct entry)
  // When a company gets VMS access, this is automatically turned ON
  requireGatepassApproval Boolean @default(false)
  
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  departments       Department[]
  users             User[]
  visitors          Visitor[]
  gatepasses        Gatepass[]
  preApprovedVisitors PreApprovedVisitor[]
  blacklistEntries  BlacklistEntry[]
  checkInRequests   CheckInRequest[]
  
  @@map("companies")
}

model Department {
  id        String    @id @default(uuid())
  companyId String
  company   Company   @relation(fields: [companyId], references: [id])
  name      String
  floor     String?
  building  String?
  phone     String?
  email     String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  
  @@unique([companyId, name])
  @@map("departments")
}

// ================================
// USER MANAGEMENT
// ================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  firstName       String
  lastName        String
  phone           String?
  profilePicture  String?
  
  // Role assignment
  roleId          String?
  role            Role?     @relation(fields: [roleId], references: [id])
  
  // Company assignment (for multi-tenant)
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id])
  
  // Account status
  isActive        Boolean   @default(true)
  isApproved      Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  visitorsCreated    Visitor[]           @relation("VisitorCreatedBy")
  gatepassesIssued   Gatepass[]          @relation("GatepassIssuedBy")
  gatepassesApproved Gatepass[]          @relation("GatepassApprovedBy")
  preApprovedBy      PreApprovedVisitor[] @relation("PreApprovedBy")
  blacklistCreated   BlacklistEntry[]    @relation("BlacklistCreatedBy")
  checkInProcessed   CheckInRequest[]    @relation("CheckInProcessedBy")
  
  @@map("users")
}

model Role {
  id          String    @id @default(uuid())
  name        String    @unique
  displayName String
  description String?
  permissions String    @default("[]") // JSON array of permission keys
  uiConfig    String    @default("{}") // JSON for UI customization
  isSystem    Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  users       User[]
  
  @@map("roles")
}

model Permission {
  id          String    @id @default(uuid())
  key         String    @unique
  name        String
  description String?
  module      String
  action      String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  @@index([module])
  @@map("permissions")
}

// ================================
// VISITOR MANAGEMENT
// ================================

model Visitor {
  id              String    @id @default(uuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  
  visitorCode     String    @unique @default(uuid())
  firstName       String
  lastName        String
  email           String?
  phone           String
  visitorCompany  String?   // Visitor's company name
  designation     String?
  address         String?
  
  // ID Proof
  idProofType     String?   // AADHAAR, PAN, PASSPORT, DRIVING_LICENSE, etc.
  idProofNumber   String?
  idProofImage    String?   // Base64 or URL
  
  // Photo
  photo           String?   // Base64 or URL
  
  // Visit history
  totalVisits     Int       @default(0)
  lastVisitDate   DateTime?
  
  // Blacklist status
  isBlacklisted   Boolean   @default(false)
  blacklistReason String?
  
  createdById     String?
  createdBy       User?     @relation("VisitorCreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  gatepasses      Gatepass[]
  preApprovals    PreApprovedVisitor[]
  
  @@index([companyId, phone])
  @@index([visitorCode])
  @@map("visitors")
}

// ================================
// GATEPASS MANAGEMENT
// ================================

model Gatepass {
  id              String    @id @default(uuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  
  gatepassNumber  String    @unique
  visitorId       String
  visitor         Visitor   @relation(fields: [visitorId], references: [id])
  
  // Visit details
  purpose         String
  purposeDetails  String?
  hostName        String
  hostDepartment  String?
  hostPhone       String?
  hostEmail       String?
  entryGate       String?
  visitingArea    String?
  
  // Time
  expectedDate    DateTime
  expectedTimeIn  DateTime?
  expectedTimeOut DateTime?
  validFrom       DateTime  @default(now())
  validUntil      DateTime
  
  // Actual times
  actualCheckIn   DateTime?
  actualCheckOut  DateTime?
  
  // Status
  status          String    @default("PENDING") // PENDING, ACTIVE, COMPLETED, CANCELLED, EXPIRED
  
  // QR Code
  qrCode          String?   // Base64 QR code image
  qrCodeData      String?   // QR code data
  
  // Items & Vehicle
  itemsCarried    String?   // JSON array
  vehicleNumber   String?
  vehicleType     String?
  
  // Security
  securityRemarks String?
  
  // Link to check-in request if created from QR flow
  checkInRequestId String?
  
  // Approval
  issuedById      String?
  issuedBy        User?     @relation("GatepassIssuedBy", fields: [issuedById], references: [id])
  issuedAt        DateTime  @default(now())
  approvedById    String?
  approvedBy      User?     @relation("GatepassApprovedBy", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  
  updatedAt       DateTime  @updatedAt
  
  @@index([companyId])
  @@index([status])
  @@map("gatepasses")
}

// ================================
// QR-BASED SELF CHECK-IN REQUESTS
// ================================

model CheckInRequest {
  id              String    @id @default(uuid())
  requestNumber   String    @unique
  
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  
  // Visitor info (captured from QR form)
  visitorName     String?   // Combined name for simplified display
  firstName       String
  lastName        String
  email           String?
  phone           String
  visitorCompany  String?
  designation     String?
  
  // ID Proof
  idProofType     String?
  idProofNumber   String?
  idProofImage    String?
  
  // Photo
  photo           String?
  
  // Visit details
  purpose         String
  purposeDetails  String?
  hostName        String?
  hostDepartment  String?
  hostPhone       String?
  hostEmail       String?
  
  // Vehicle
  hasVehicle      Boolean   @default(false)
  vehicleNumber   String?
  vehicleType     String?
  
  // Items
  itemsCarried    String?   // JSON array
  
  // Status
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, CHECKED_IN, CHECKED_OUT, EXPIRED
  
  // Processing
  processedById   String?
  processedBy     User?     @relation("CheckInProcessedBy", fields: [processedById], references: [id])
  processedAt     DateTime?
  processingNote  String?
  rejectionReason String?
  
  // Check-in/out times
  checkInAt       DateTime?
  checkOutAt      DateTime?
  checkInTime     DateTime?  // Alias for easier access
  checkOutTime    DateTime?  // Alias for easier access
  
  // Computed helper fields
  visitorPhone    String?    // Alias for phone
  visitorEmail    String?    // Alias for email
  visitPurpose    String?    // Alias for purpose
  department      String?    // Alias for hostDepartment
  
  // Link to gatepass if created
  gatepassId      String?
  
  // Timestamps
  submittedAt     DateTime  @default(now())
  expiresAt       DateTime
  updatedAt       DateTime  @updatedAt
  
  // Device info
  deviceInfo      String?
  ipAddress       String?
  
  @@index([companyId, status])
  @@index([phone])
  @@map("check_in_requests")
}

// ================================
// PRE-APPROVED VISITORS
// ================================

model PreApprovedVisitor {
  id              String    @id @default(uuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  
  // Can link to existing visitor or store new details
  visitorId       String?
  visitor         Visitor?  @relation(fields: [visitorId], references: [id])
  
  // Or store visitor details directly
  firstName       String?
  lastName        String?
  phone           String?
  email           String?
  visitorCompany  String?
  
  // Purpose & Host
  purpose         String?
  hostName        String
  hostDepartment  String?
  hostPhone       String?
  hostEmail       String?
  visitingArea    String?
  
  // Validity
  validFrom       DateTime
  validUntil      DateTime
  
  // Multi-entry support
  isMultiEntry    Boolean   @default(false)
  maxEntries      Int       @default(1)
  usedEntries     Int       @default(0)
  
  // Status
  status          String    @default("ACTIVE") // ACTIVE, USED, EXPIRED, CANCELLED
  
  // Approval
  approvedById    String?
  approvedBy      User?     @relation("PreApprovedBy", fields: [approvedById], references: [id])
  approvedAt      DateTime  @default(now())
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([companyId])
  @@index([phone])
  @@index([status])
  @@map("pre_approved_visitors")
}

// ================================
// BLACKLIST MANAGEMENT
// ================================

model BlacklistEntry {
  id              String    @id @default(uuid())
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id])
  
  // Can link to visitor or store details
  visitorId       String?
  
  // Or store visitor details directly
  firstName       String?
  lastName        String?
  phone           String?
  email           String?
  idProofType     String?
  idProofNumber   String?
  photo           String?
  
  // Blacklist details
  reason          String
  reasonDetails   String?
  incidentDate    DateTime?
  incidentLocation String?
  
  // Scope
  isGlobal        Boolean   @default(false) // If true, applies to all companies
  isActive        Boolean   @default(true)
  expiresAt       DateTime?
  
  createdById     String?
  createdBy       User?     @relation("BlacklistCreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([companyId])
  @@index([phone])
  @@map("blacklist_entries")
}

// ================================
// SYSTEM & ANALYTICS
// ================================

model AuditLog {
  id          String    @id @default(uuid())
  userId      String?
  action      String
  entity      String
  entityId    String?
  oldValue    String?
  newValue    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSettings {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String
  description String?
  updatedAt   DateTime  @updatedAt
  
  @@map("system_settings")
}

model AnalyticsCache {
  id          String    @id @default(uuid())
  reportType  String
  reportName  String
  data        String    // JSON data
  filters     String?   // JSON filters
  generatedAt DateTime  @default(now())
  expiresAt   DateTime
  createdBy   String?
  
  @@map("analytics_cache")
}
