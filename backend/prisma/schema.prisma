// Work Permit System Database Schema
// Using MySQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid()) @db.VarChar(36)
  email           String          @unique @db.VarChar(255)
  password        String          @db.VarChar(255)
  firstName       String          @db.VarChar(100)
  lastName        String          @db.VarChar(100)
  roleId          String?         @db.VarChar(36)
  department      String?         @db.VarChar(100)
  phone           String?         @db.VarChar(20)
  profilePicture  String?         @db.Text
  isActive        Boolean         @default(true)
  isApproved      Boolean         @default(false)
  requestedRole   String?         @db.VarChar(50)
  approvedBy      String?         @db.VarChar(36)
  approvedAt      DateTime?
  rejectionReason String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  role            Role?           @relation(fields: [roleId], references: [id])
  permitRequests  PermitRequest[]
  
  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @unique @db.VarChar(50)
  displayName String   @db.VarChar(100)
  description String?  @db.Text
  permissions String   @default("[]") @db.Text
  uiConfig    String   @default("{}") @db.Text
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid()) @db.VarChar(36)
  key         String   @unique @db.VarChar(100)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  module      String   @db.VarChar(50)
  action      String   @db.VarChar(50)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([module])
  @@map("permissions")
}

model PermitRequest {
  id               String    @id @default(uuid()) @db.VarChar(36)
  permitNumber     String    @unique @db.VarChar(50)
  title            String    @db.VarChar(255)
  description      String    @db.Text
  location         String    @db.VarChar(255)
  workType         String    @db.VarChar(100)
  startDate        DateTime
  endDate          DateTime
  status           String    @default("PENDING") @db.VarChar(20)
  priority         String    @default("MEDIUM") @db.VarChar(20)
  hazards          String    @default("[]") @db.Text
  precautions      String    @default("[]") @db.Text
  equipment        String    @default("[]") @db.Text
  measures         String    @default("[]") @db.Text
  workers          String    @default("[]") @db.Text
  vendorDetails    String?   @db.Text
  contractorName   String?   @db.VarChar(255)
  contractorPhone  String?   @db.VarChar(20)
  companyName      String?   @db.VarChar(255)
  companyLogo      String?   @db.Text
  timezone         String    @default("UTC") @db.VarChar(50)
  isExtended       Boolean   @default(false)
  extendedUntil    DateTime?
  closedAt         DateTime?
  closureChecklist String    @default("[]") @db.Text
  safetyRemarks    String?   @db.Text
  remarksAddedBy   String?   @db.VarChar(36)
  remarksAddedAt   DateTime?
  autoClosedAt     DateTime?
  createdBy        String    @db.VarChar(36)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  user          User                  @relation(fields: [createdBy], references: [id])
  approvals     PermitApproval[]
  actionHistory PermitActionHistory[]
  
  @@index([status])
  @@index([createdBy])
  @@index([startDate, endDate])
  @@map("permit_requests")
}

model PermitApproval {
  id           String    @id @default(uuid()) @db.VarChar(36)
  permitId     String    @db.VarChar(36)
  approverName String?   @db.VarChar(255)
  approverRole String    @default("FIREMAN") @db.VarChar(50)
  decision     String    @default("PENDING") @db.VarChar(20)
  comment      String?   @db.Text
  signature    String?   @db.LongText
  signedAt     DateTime?
  approvedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  permit       PermitRequest @relation(fields: [permitId], references: [id], onDelete: Cascade)
  
  @@index([permitId])
  @@index([decision])
  @@map("permit_approvals")
}

model PermitActionHistory {
  id              String   @id @default(uuid()) @db.VarChar(36)
  permitId        String   @db.VarChar(36)
  action          String   @db.VarChar(50)
  performedBy     String?  @db.VarChar(36)
  performedByName String?  @db.VarChar(255)
  performedByRole String?  @db.VarChar(50)
  comment         String?  @db.Text
  previousStatus  String?  @db.VarChar(20)
  newStatus       String?  @db.VarChar(20)
  signature       String?  @db.LongText
  createdAt       DateTime @default(now())
  
  permit          PermitRequest @relation(fields: [permitId], references: [id], onDelete: Cascade)
  
  @@index([permitId])
  @@index([action])
  @@map("permit_action_history")
}

model Worker {
  id          String   @id @default(uuid()) @db.VarChar(36)
  name        String   @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(255)
  company     String?  @db.VarChar(255)
  trade       String?  @db.VarChar(100)
  badgeNumber String?  @db.VarChar(50)
  photo       String?  @db.LongText
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([phone])
  @@index([badgeNumber])
  @@map("workers")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String?  @db.VarChar(36)
  action    String   @db.VarChar(100)
  entity    String   @db.VarChar(100)
  entityId  String?  @db.VarChar(36)
  oldValue  String?  @db.LongText
  newValue  String?  @db.LongText
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text
  createdAt DateTime @default(now())
  
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSettings {
  id          String   @id @default(uuid()) @db.VarChar(36)
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.Text
  updatedAt   DateTime @updatedAt
  
  @@map("system_settings")
}

model SSOToken {
  id             String   @id @default(uuid()) @db.VarChar(36)
  token          String   @unique @db.VarChar(255)
  userId         String   @db.VarChar(36)
  externalUserId String?  @db.VarChar(36)
  externalSystem String   @default("VMS") @db.VarChar(50)
  expiresAt      DateTime
  isUsed         Boolean  @default(false)
  createdAt      DateTime @default(now())
  
  @@index([token])
  @@index([expiresAt])
  @@map("sso_tokens")
}

model AnalyticsCache {
  id          String   @id @default(uuid()) @db.VarChar(36)
  reportType  String   @db.VarChar(50)
  reportName  String   @db.VarChar(255)
  data        String   @db.LongText
  filters     String?  @db.Text
  generatedAt DateTime @default(now())
  expiresAt   DateTime
  createdBy   String?  @db.VarChar(36)
  
  @@index([reportType])
  @@index([expiresAt])
  @@map("analytics_cache")
}
